<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Advanced financial lease vs rent analysis tool">
<title>Lease vs Rent Analysis | Aladdin Finance</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary-dark: #0a1628;
  --primary-light: #f8fafc;
  --surface-primary: #0f1e2e;
  --surface-secondary: #1a2a3a;
  --surface-tertiary: #243548;
  --accent-primary: #00d9ff;
  --accent-secondary: #6366f1;
  --accent-tertiary: #8b5cf6;
  --text-primary: #f0f4f8;
  --text-secondary: #cbd5e1;
  --text-tertiary: #94a3b8;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
  --shadow-md: 0 8px 24px rgba(0,0,0,0.15);
  --shadow-lg: 0 20px 48px rgba(0,0,0,0.2);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body.light {
  --primary-dark: #ffffff;
  --surface-primary: #f8fafc;
  --surface-secondary: #f1f5f9;
  --surface-tertiary: #e2e8f0;
  --text-primary: #0f172a;
  --text-secondary: #334155;
  --text-tertiary: #64748b;
}

html { scroll-behavior: smooth; }

body {
  background: linear-gradient(135deg, var(--primary-dark) 0%, #0f2540 100%);
  color: var(--text-primary);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  font-size: 16px;
  line-height: 1.6;
  transition: var(--transition);
  min-height: 100vh;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle at 20% 50%, rgba(0,217,255,0.05) 0%, transparent 50%),
              radial-gradient(circle at 80% 80%, rgba(99,102,241,0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: var(--accent-primary);
  color: var(--primary-dark);
  padding: 8px 16px;
  border-radius: 0 0 var(--radius-md) 0;
  z-index: 1000;
  font-weight: 600;
}

.skip-link:focus {
  top: 0;
}

.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(10,22,40,0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(0,217,255,0.1);
  padding: 16px 32px;
  transition: var(--transition);
}

.header-content {
  max-width: 1600px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 24px;
}

.logo {
  font-size: 22px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.btn-theme {
  background: var(--surface-secondary);
  border: 1px solid rgba(0,217,255,0.2);
  color: var(--text-primary);
  padding: 10px 20px;
  border-radius: var(--radius-lg);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-theme:hover {
  background: var(--surface-tertiary);
  border-color: var(--accent-primary);
  box-shadow: 0 0 12px rgba(0,217,255,0.2);
}

.btn-theme:focus {
  outline: 2px solid var(--accent-primary);
  outline-offset: 2px;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 32px;
  display: grid;
  gap: 32px;
}

.section-header {
  display: grid;
  gap: 12px;
}

.section-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.5px;
}

.section-subtitle {
  font-size: 14px;
  color: var(--text-tertiary);
  font-weight: 500;
}

.intro-box {
  background: rgba(0,217,255,0.08);
  border-left: 4px solid var(--accent-primary);
  padding: 16px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-secondary);
}

.card {
  background: linear-gradient(135deg, var(--surface-primary) 0%, var(--surface-secondary) 100%);
  border: 1px solid rgba(0,217,255,0.1);
  border-radius: var(--radius-xl);
  padding: 28px;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-md);
  transition: var(--transition);
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.6s ease forwards;
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }

.card:hover {
  border-color: rgba(0,217,255,0.3);
  box-shadow: 0 20px 48px rgba(0,217,255,0.1), var(--shadow-lg);
  transform: translateY(-4px);
}

@keyframes fadeInUp {
  to { opacity: 1; transform: translateY(0); }
}

/* Collapsible sections */
.collapsible-section {
  border: 1px solid rgba(0,217,255,0.1);
  border-radius: var(--radius-lg);
  margin-bottom: 16px;
  overflow: hidden;
}

.collapsible-header {
  background: rgba(0,217,255,0.05);
  padding: 16px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  color: var(--text-secondary);
  user-select: none;
  transition: var(--transition);
}

.collapsible-header:hover {
  background: rgba(0,217,255,0.1);
}

.collapsible-header:focus-within {
  outline: 2px solid var(--accent-primary);
  outline-offset: -1px;
}

.collapsible-toggle {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.collapsible-section.open .collapsible-toggle {
  transform: rotate(180deg);
}

.collapsible-content {
  display: none;
  padding: 20px 16px;
  border-top: 1px solid rgba(0,217,255,0.1);
}

.collapsible-section.open .collapsible-content {
  display: block;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 16px;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.form-label {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-tertiary);
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}

.form-field:focus-within .form-label {
  color: var(--accent-primary);
}

.tooltip-icon {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: rgba(0,217,255,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  cursor: help;
  position: relative;
  flex-shrink: 0;
  transition: var(--transition);
}

.tooltip-icon:hover {
  background: rgba(0,217,255,0.5);
  transform: scale(1.1);
}

.tooltip-icon:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface-tertiary);
  color: var(--text-primary);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 12px;
  white-space: nowrap;
  border: 1px solid rgba(0,217,255,0.2);
  z-index: 10;
  pointer-events: none;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.form-input {
  background: var(--surface-tertiary);
  border: 1.5px solid rgba(0,217,255,0.1);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  padding: 14px 16px;
  font-size: 14px;
  font-weight: 600;
  transition: var(--transition);
  font-family: 'Courier New', monospace;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent-primary);
  background: var(--surface-secondary);
  box-shadow: 0 0 12px rgba(0,217,255,0.15);
}

.form-input:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

input[type="range"] {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  background: var(--surface-tertiary);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
  accent-color: var(--accent-primary);
  touch-action: none;
  display: block;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--accent-primary);
  cursor: grab;
  box-shadow: 0 0 12px rgba(0,217,255,0.4), 0 2px 8px rgba(0,0,0,0.3);
  transition: var(--transition);
  border: 2px solid var(--surface-secondary);
}

input[type="range"]::-webkit-slider-thumb:active {
  cursor: grabbing;
  width: 28px;
  height: 28px;
  box-shadow: 0 0 24px rgba(0,217,255,0.6), 0 4px 12px rgba(0,0,0,0.4);
}

input[type="range"]::-webkit-slider-thumb:hover:not(:active) {
  width: 26px;
  height: 26px;
  box-shadow: 0 0 20px rgba(0,217,255,0.6), 0 2px 8px rgba(0,0,0,0.3);
}

input[type="range"]::-moz-range-thumb {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--accent-primary);
  cursor: grab;
  border: 2px solid var(--surface-secondary);
  box-shadow: 0 0 12px rgba(0,217,255,0.4), 0 2px 8px rgba(0,0,0,0.3);
  transition: var(--transition);
}

input[type="range"]::-moz-range-thumb:active {
  cursor: grabbing;
  width: 28px;
  height: 28px;
  box-shadow: 0 0 24px rgba(0,217,255,0.6), 0 4px 12px rgba(0,0,0,0.4);
}

input[type="range"]::-moz-range-thumb:hover {
  width: 26px;
  height: 26px;
  box-shadow: 0 0 20px rgba(0,217,255,0.6), 0 2px 8px rgba(0,0,0,0.3);
}

input[type="range"]::-moz-range-track {
  background: transparent;
  border: none;
}

input[type="range"]::-moz-range-track-lower {
  background: transparent;
}

input[type="range"]::-moz-range-track-upper {
  background: transparent;
}

.form-hint {
  font-size: 12px;
  color: var(--accent-primary);
  font-weight: 600;
  min-height: 16px;
  margin-top: -2px;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.metric-card {
  background: rgba(0,217,255,0.05);
  border: 1px solid rgba(0,217,255,0.2);
  border-radius: var(--radius-lg);
  padding: 18px;
  transition: var(--transition);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.metric-card:hover {
  background: rgba(0,217,255,0.08);
  border-color: rgba(0,217,255,0.4);
  transform: translateY(-2px);
}

.metric-card.positive { border-left: 4px solid var(--success); }
.metric-card.negative { border-left: 4px solid var(--danger); }
.metric-card.neutral { border-left: 4px solid var(--warning); }

.metric-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

.metric-value {
  font-size: 26px;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.5px;
}

.metric-sub {
  font-size: 12px;
  color: var(--text-tertiary);
  font-weight: 500;
  margin-top: 4px;
}

.gauge-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 32px;
}

.gauge-wrapper {
  position: relative;
  width: 240px;
  height: 240px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.gauge-arc {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: conic-gradient(from 0deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  box-shadow: 0 0 40px rgba(0,217,255,0.2), inset 0 0 40px rgba(0,217,255,0.05);
}

.gauge-inner {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: var(--surface-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: 900;
  color: var(--accent-primary);
  letter-spacing: -1px;
  box-shadow: inset 0 8px 24px rgba(0,0,0,0.3);
}

.gauge-label {
  font-size: 13px;
  color: var(--text-tertiary);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 8px;
}

.chart-container {
  position: relative;
  height: 400px;
  padding: 24px 0;
}

canvas { max-height: 100% !important; }

.chart-card {
  background: linear-gradient(135deg, var(--surface-primary) 0%, var(--surface-secondary) 100%);
  border: 1px solid rgba(0,217,255,0.1);
  border-radius: var(--radius-xl);
  padding: 28px;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-md);
  transition: var(--transition);
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.6s ease forwards;
}

.chart-card:nth-of-type(1) { animation-delay: 0.1s; }
.chart-card:nth-of-type(2) { animation-delay: 0.2s; }
.chart-card:nth-of-type(3) { animation-delay: 0.3s; }
.chart-card:nth-of-type(4) { animation-delay: 0.4s; }
.chart-card:nth-of-type(5) { animation-delay: 0.5s; }
.chart-card:nth-of-type(6) { animation-delay: 0.6s; }
.chart-card:nth-of-type(7) { animation-delay: 0.7s; }

.chart-card:hover {
  border-color: rgba(0,217,255,0.3);
  box-shadow: 0 20px 48px rgba(0,217,255,0.1), var(--shadow-lg);
  transform: translateY(-4px);
}

.chart-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.chart-icon {
  width: 4px;
  height: 24px;
  background: linear-gradient(180deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
  border-radius: 2px;
  flex-shrink: 0;
}

.chart-description {
  font-size: 13px;
  color: var(--text-tertiary);
  margin-top: 16px;
  line-height: 1.6;
  padding-top: 12px;
  border-top: 1px solid rgba(0,217,255,0.1);
}

.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
  gap: 24px;
}

.text-center { text-align: center; }
.text-success { color: var(--success); }
.text-warning { color: var(--warning); }
.text-danger { color: var(--danger); }

@media (max-width: 1400px) {
  .charts-grid { grid-template-columns: 1fr; }
}

@media (max-width: 1024px) {
  .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
}

@media (max-width: 768px) {
  .container { padding: 16px; gap: 20px; }
  .card { padding: 20px; }
  .form-grid { grid-template-columns: 1fr; gap: 24px; }
  .form-field { gap: 12px; }
  .form-input { padding: 16px 16px; font-size: 16px; }
  input[type="range"] { height: 12px; margin: 8px 0; }
  input[type="range"]::-webkit-slider-thumb { width: 28px; height: 28px; }
  input[type="range"]::-moz-range-thumb { width: 28px; height: 28px; }
  .section-title { font-size: 22px; }
  .gauge-wrapper { width: 180px; height: 180px; }
  .gauge-inner { width: 150px; height: 150px; font-size: 32px; }
  .chart-container { height: 300px; }
  .collapsible-header { padding: 14px; font-size: 14px; }
  .collapsible-content { padding: 16px 14px; }
  .tooltip-icon:hover::after { 
    font-size: 11px;
    padding: 8px 10px;
    white-space: normal;
    max-width: 200px;
    bottom: 130%;
  }
}
</style>
</head>

<body>

<a href="#main" class="skip-link">Skip to main content</a>

<header class="header" role="banner">
  <div class="header-content">
    <div class="logo">üí∞ Aladdin Finance</div>
    <button class="btn-theme" onclick="toggleTheme()" aria-label="Toggle dark/light theme">
      <span id="theme-icon" aria-hidden="true">üåô</span>
      <span id="theme-text">Dark</span>
    </button>
  </div>
</header>

<main id="main" class="container" role="main">

  <section class="section-header">
    <h1 class="section-title">Lease vs Rent Analysis</h1>
    <p class="section-subtitle">Advanced financial modeling to determine the optimal leasing or renting strategy</p>
    <div class="intro-box" role="region" aria-label="Overview">
      <strong>How it works:</strong> Enter your financial parameters below. The tool calculates total economic costs for both lease and rent options, including interest, opportunity costs, and maintenance. Results help you make an informed decision.
    </div>
  </section>

  <!-- Input Parameters -->
  <section class="card" aria-labelledby="params-title">
    <h2 id="params-title" style="font-size: 18px; margin-bottom: 24px; color: var(--text-primary); font-weight: 700;">Financial Parameters</h2>

    <!-- Lease Components - Collapsible -->
    <div class="collapsible-section open">
      <button class="collapsible-header" onclick="toggleCollapsible(this)" aria-expanded="true" aria-controls="lease-content">
        <span>üìã Lease Components</span>
        <span class="collapsible-toggle">‚ñº</span>
      </button>
      <div id="lease-content" class="collapsible-content">
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              Lease Amount
              <span class="tooltip-icon" data-tooltip="Total lease or purchase price">?</span>
            </label>
            <input id="leaseAmount" class="form-input" type="text" inputmode="numeric" value="2000000" aria-label="Lease amount in rupees">
            <input type="range" id="leaseAmountRange" min="100000" max="5000000" step="50000" value="2000000" aria-label="Lease amount slider">
            <div class="form-hint">‚Çπ Amount</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Loan Amount
              <span class="tooltip-icon" data-tooltip="Amount to be financed">?</span>
            </label>
            <input id="loanAmount" class="form-input" type="text" inputmode="numeric" value="1500000" aria-label="Loan amount in rupees">
            <input type="range" id="loanAmountRange" min="0" max="5000000" step="50000" value="1500000" aria-label="Loan amount slider">
            <div class="form-hint">‚Çπ Amount</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Loan Interest Rate
              <span class="tooltip-icon" data-tooltip="Annual percentage rate">?</span>
            </label>
            <input id="loanRate" class="form-input" type="text" inputmode="decimal" value="8.5" aria-label="Loan interest rate percentage">
            <input type="range" id="loanRateRange" min="1" max="20" step="0.1" value="8.5" aria-label="Loan rate slider">
            <div id="emiLabel" class="form-hint"></div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Monthly Maintenance
              <span class="tooltip-icon" data-tooltip="Recurring upkeep costs">?</span>
            </label>
            <input id="maintenance" class="form-input" type="text" inputmode="numeric" value="5000" aria-label="Monthly maintenance in rupees">
            <input type="range" id="maintenanceRange" min="0" max="20000" step="500" value="5000" aria-label="Maintenance slider">
            <div class="form-hint">‚Çπ Per month</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Withholding %
              <span class="tooltip-icon" data-tooltip="Percentage of deposit held back">?</span>
            </label>
            <input id="withholding" class="form-input" type="text" inputmode="decimal" value="0" aria-label="Withholding percentage">
            <div class="form-hint">% Of lease</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Refund Delay
              <span class="tooltip-icon" data-tooltip="Months to recover deposit">?</span>
            </label>
            <input id="refundDelay" class="form-input" type="text" inputmode="numeric" value="0" aria-label="Refund delay in months">
            <div class="form-hint">Months</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rent Components - Collapsible -->
    <div class="collapsible-section open">
      <button class="collapsible-header" onclick="toggleCollapsible(this)" aria-expanded="true" aria-controls="rent-content">
        <span>üè† Rent Components</span>
        <span class="collapsible-toggle">‚ñº</span>
      </button>
      <div id="rent-content" class="collapsible-content">
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              Market Rent
              <span class="tooltip-icon" data-tooltip="Current monthly rent">?</span>
            </label>
            <input id="marketRent" class="form-input" type="text" inputmode="numeric" value="45000" aria-label="Monthly market rent in rupees">
            <input type="range" id="marketRentRange" min="5000" max="200000" step="1000" value="45000" aria-label="Market rent slider">
            <div class="form-hint">‚Çπ Per month</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Rent Deposit
              <span class="tooltip-icon" data-tooltip="Security deposit required">?</span>
            </label>
            <input id="rentDeposit" class="form-input" type="text" inputmode="numeric" value="0" aria-label="Rent deposit in rupees">
            <input type="range" id="rentDepositRange" min="0" max="500000" step="10000" value="0" aria-label="Rent deposit slider">
            <div class="form-hint">‚Çπ Amount</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Deposit Refund Delay
              <span class="tooltip-icon" data-tooltip="Months to get deposit back">?</span>
            </label>
            <input id="depositRefundDelay" class="form-input" type="text" inputmode="numeric" value="0" aria-label="Deposit refund delay in months">
            <input type="range" id="depositRefundDelayRange" min="0" max="12" step="1" value="0" aria-label="Deposit refund delay slider">
            <div class="form-hint">Months</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Rent Increment
              <span class="tooltip-icon" data-tooltip="Annual rent increase rate">?</span>
            </label>
            <input id="rentIncrement" class="form-input" type="text" inputmode="decimal" value="5" aria-label="Annual rent increment percentage">
            <input type="range" id="rentIncrementRange" min="0" max="10" step="0.5" value="5" aria-label="Rent increment slider">
            <div class="form-hint">% Per year</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Common Parameters - Collapsible -->
    <div class="collapsible-section open">
      <button class="collapsible-header" onclick="toggleCollapsible(this)" aria-expanded="true" aria-controls="common-content">
        <span>‚öñÔ∏è Common Parameters</span>
        <span class="collapsible-toggle">‚ñº</span>
      </button>
      <div id="common-content" class="collapsible-content">
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              Lease Tenure
              <span class="tooltip-icon" data-tooltip="Duration of the lease">?</span>
            </label>
            <input id="leaseTenure" class="form-input" type="text" inputmode="numeric" value="240" aria-label="Lease tenure in months">
            <input type="range" id="leaseTenureRange" min="12" max="360" step="12" value="240" aria-label="Lease tenure slider">
            <div class="form-hint">Months</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Loan Tenure
              <span class="tooltip-icon" data-tooltip="Duration of loan repayment">?</span>
            </label>
            <input id="loanTenure" class="form-input" type="text" inputmode="numeric" value="240" aria-label="Loan tenure in months">
            <input type="range" id="loanTenureRange" min="12" max="360" step="12" value="240" aria-label="Loan tenure slider">
            <div class="form-hint">Months</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Opportunity Cost
              <span class="tooltip-icon" data-tooltip="Return on alternative investment">?</span>
            </label>
            <input id="oppRate" class="form-input" type="text" inputmode="decimal" value="12" aria-label="Opportunity cost percentage">
            <input type="range" id="oppRateRange" min="1" max="20" step="0.1" value="12" aria-label="Opportunity cost slider">
            <div id="oppLabel" class="form-hint"></div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Risk Premium
              <span class="tooltip-icon" data-tooltip="Extra cost for financial risk">?</span>
            </label>
            <input id="riskPremium" class="form-input" type="text" inputmode="decimal" value="3" aria-label="Risk premium percentage">
            <input type="range" id="riskPremiumRange" min="0" max="20" step="0.1" value="3" aria-label="Risk premium slider">
            <div id="riskLabel" class="form-hint"></div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Inflation Rate
              <span class="tooltip-icon" data-tooltip="General price increase rate">?</span>
            </label>
            <input id="inflationRate" class="form-input" type="text" inputmode="decimal" value="6" aria-label="Inflation rate percentage">
            <input type="range" id="inflationRateRange" min="0" max="15" step="0.5" value="6" aria-label="Inflation rate slider">
            <div class="form-hint">% Per year</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Liquidity Premium
              <span class="tooltip-icon" data-tooltip="Cost of capital being locked">?</span>
            </label>
            <input id="liquidityPremium" class="form-input" type="text" inputmode="decimal" value="2" aria-label="Liquidity premium percentage">
            <input type="range" id="liquidityPremiumRange" min="0" max="10" step="0.5" value="2" aria-label="Liquidity premium slider">
            <div class="form-hint">% Per year</div>
          </div>
          <div class="form-field">
            <label class="form-label">
              Return Volatility
              <span class="tooltip-icon" data-tooltip="Variability of returns">?</span>
            </label>
            <input id="returnVol" class="form-input" type="text" inputmode="numeric" value="15" aria-label="Return volatility percentage">
            <input type="range" id="returnVolRange" min="0" max="40" step="1" value="15" aria-label="Return volatility slider">
            <div class="form-hint">% Variance</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPI Dashboard -->
  <section class="card" aria-labelledby="kpi-title">
    <h2 id="kpi-title" style="font-size: 18px; margin-bottom: 24px; color: var(--text-primary); font-weight: 700;">Key Performance Indicators</h2>
    <div class="metrics-grid">
      <div class="metric-card neutral" role="region" aria-label="Monthly EMI">
        <div class="metric-label">Monthly EMI</div>
        <div class="metric-value" id="mEMI">‚Çπ0</div>
        <div class="metric-sub">Loan repayment per month</div>
      </div>
      <div class="metric-card neutral" role="region" aria-label="Risk-adjusted rent">
        <div class="metric-label">Risk Rent</div>
        <div class="metric-value" id="mRiskRent">‚Çπ0</div>
        <div class="metric-sub">Effective lease cost per month</div>
      </div>
      <div class="metric-card" id="savingsCard" role="region" aria-label="Monthly savings">
        <div class="metric-label">Monthly Savings</div>
        <div class="metric-value" id="mSave">‚Çπ0</div>
        <div class="metric-sub" id="mSaveSub"></div>
      </div>
      <div class="metric-card" id="annualCard" role="region" aria-label="Annual savings">
        <div class="metric-label">Annual Savings</div>
        <div class="metric-value" id="ySave">‚Çπ0</div>
        <div class="metric-sub">Extrapolated from monthly</div>
      </div>
      <div class="metric-card" id="termCard" role="region" aria-label="Total term savings">
        <div class="metric-label">Term Savings</div>
        <div class="metric-value" id="tSave">‚Çπ0</div>
        <div class="metric-sub">Over full lease tenure</div>
      </div>
      <div class="metric-card neutral" role="region" aria-label="Decision strength">
        <div class="metric-label">Decision Strength</div>
        <div class="metric-value" id="mConfidence">0%</div>
        <div class="metric-sub">Confidence in the outcome</div>
      </div>
      <div class="metric-card" id="scoreCard" role="region" aria-label="Financial score">
        <div class="metric-label">Financial Score</div>
        <div class="metric-value" id="scoreValue">0%</div>
        <div class="metric-sub" id="scoreChange">Analyzing...</div>
      </div>
    </div>
  </section>

  <!-- Score Gauge -->
  <section class="card" aria-labelledby="gauge-title">
    <div class="gauge-container">
      <div class="gauge-wrapper" aria-label="Lease advantage score">
        <div id="gauge" class="gauge-arc" role="img">
          <div class="gauge-inner">
            <span id="dial" aria-label="Score value">0</span>
            <div class="gauge-label">Score</div>
          </div>
        </div>
      </div>
      <div class="text-center">
        <h2 id="gauge-title" class="section-subtitle">Lease vs Rent Advantage Score</h2>
        <p style="font-size: 13px; color: var(--text-tertiary); margin-top: 12px;">
          <span id="scoreInterpretation" role="status" aria-live="polite">Analyzing your financial parameters...</span>
        </p>
      </div>
    </div>
  </section>

  <!-- Charts Row 1 -->
  <section class="charts-grid">
    <div class="chart-card">
      <div class="chart-title"><div class="chart-icon"></div>Total Economic Cost Drivers (Lease)</div>
      <div class="chart-container"><canvas id="tcoChart" role="img" aria-label="Cost breakdown chart"></canvas></div>
      <div class="chart-description">
        üìå Breakdown of all economic cost components driving the lease cost: interest paid, own funds opportunity cost, withholding loss, maintenance, and refund delay.
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title"><div class="chart-icon"></div>Monthly Cost Comparison</div>
      <div class="chart-container"><canvas id="monthlyCostChart" role="img" aria-label="Monthly cost evolution chart"></canvas></div>
      <div class="chart-description">
        üìä Tracks how monthly costs evolve over time. Green shows escalating market rent, red shows EMI + maintenance outflow during the loan period.
      </div>
    </div>
  </section>

  <!-- Charts Row 2 -->
  <section class="charts-grid">
    <div class="chart-card">
      <div class="chart-title"><div class="chart-icon"></div>Cumulative Cost Analysis</div>
      <div class="chart-container"><canvas id="cumulativeCostChart" role="img" aria-label="Cumulative cost chart"></canvas></div>
      <div class="chart-description">
        üí∞ Total accumulated costs over lease tenure. Shows the spread between economic lease cost and market rent ‚Äî the wider the gap, the stronger the advantage.
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title"><div class="chart-icon"></div>Forward Rent Projection</div>
      <div class="chart-container"><canvas id="forwardRentChart" role="img" aria-label="Rent projection chart"></canvas></div>
      <div class="chart-description">
        üìà How market rent escalates annually over the lease tenure. Shows cumulative rent burden and the monthly rent trajectory vs. the fixed lease cost.
      </div>
    </div>
  </section>

  <!-- Charts Row 3 -->
  <section class="charts-grid">
    <div class="chart-card">
      <div class="chart-title"><div class="chart-icon"></div>Cost Composition (Lease)</div>
      <div class="chart-container"><canvas id="compositionChart" role="img" aria-label="Lease cost composition chart"></canvas></div>
      <div class="chart-description">
        ü•ß What's driving the lease cost? Proportion of each economic cost category: interest, opportunity cost, maintenance, withholding, and refund delay.
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title"><div class="chart-icon"></div>Sensitivity Analysis</div>
      <div class="chart-container"><canvas id="sensitivityChart" role="img" aria-label="Sensitivity analysis chart"></canvas></div>
      <div class="chart-description">
        ‚ö†Ô∏è How do monthly savings change as risk rent varies ¬±20%? Tests the robustness of the lease-vs-rent decision against cost assumptions.
      </div>
    </div>
  </section>

  <!-- Amortization Full Width -->
  <section class="chart-card">
    <div class="chart-title"><div class="chart-icon"></div>Loan Amortization Schedule</div>
    <div class="chart-container"><canvas id="amortizationChart" role="img" aria-label="Amortization schedule chart"></canvas></div>
    <div class="chart-description">
      üìâ Principal vs interest breakdown per month over the effective loan tenure. Interest is front-loaded in early months ‚Äî a shorter loan tenure reduces total interest significantly.
    </div>
  </section>

</main>

<script>
Chart.register(window['ChartDataLabels']);

// ===================== THEME =====================
function toggleTheme() {
  document.body.classList.toggle('light');
  const isDark = !document.body.classList.contains('light');
  document.getElementById('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  document.getElementById('theme-text').textContent = isDark ? 'Dark' : 'Light';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  updateCharts();
}

function toggleCollapsible(button) {
  const section = button.parentElement;
  section.classList.toggle('open');
  button.setAttribute('aria-expanded', section.classList.contains('open'));
}

if (localStorage.getItem('theme') === 'light') {
  document.body.classList.add('light');
  document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
  document.getElementById('theme-text').textContent = 'Light';
}

// ===================== HELPERS =====================
const $ = id => document.getElementById(id);

function cleanNumber(v) {
  return parseFloat((v || '').replace(/[,%\s‚Çπ]/g, '')) || 0;
}

function num(id) {
  return cleanNumber($(id).value);
}

function formatCurrency(n) {
  return '‚Çπ' + Math.round(n || 0).toLocaleString('en-IN');
}

// ===================== INPUT SYNC =====================
['leaseAmount','loanAmount','loanRate','oppRate','riskPremium','marketRent','maintenance',
 'rentIncrement','loanTenure','leaseTenure','rentDeposit','depositRefundDelay',
 'inflationRate','liquidityPremium','returnVol']
  .forEach(id => {
    const input = $(id);
    const range = $(id + 'Range');
    if (!range) return;
    range.addEventListener('input', () => { input.value = range.value; calculate(); });
    input.addEventListener('input', () => { range.value = cleanNumber(input.value); calculate(); });
  });

['withholding','refundDelay'].forEach(id => {
  $(id).addEventListener('input', calculate);
});

// ===================== EMI =====================
function calcEMI(P, r, n) {
  if (r === 0) return P / n;
  return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
}

// ===================== CHART INSTANCES =====================
let tcoChart, monthlyCostChart, cumulativeCostChart, forwardRentChart;
let compositionChart, sensitivityChart, amortizationChart;

function updateCharts() {
  if (tcoChart) tcoChart.update();
  if (monthlyCostChart) monthlyCostChart.update();
  if (cumulativeCostChart) cumulativeCostChart.update();
  if (forwardRentChart) forwardRentChart.update();
  if (compositionChart) compositionChart.update();
  if (sensitivityChart) sensitivityChart.update();
  if (amortizationChart) amortizationChart.update();
}

// ===================== CHART COLOR =====================
function getChartColor(inflation, liquidity) {
  const stress = (inflation + liquidity) / 2;
  if (stress > 8) return '#ef4444';
  if (stress > 4) return '#f59e0b';
  return '#10b981';
}

// ===================== MAIN CALCULATION =====================
function calculate() {
  try {
    const LEASE_AMOUNT         = num('leaseAmount');
    const LOAN_AMOUNT          = num('loanAmount');
    const LOAN_RATE_ANNUAL     = num('loanRate');
    const OPP_RATE_ANNUAL      = num('oppRate');
    const RISK_PREMIUM         = num('riskPremium') / 100;
    const MARKET_RENT          = num('marketRent');
    const MAINTENANCE          = num('maintenance');
    const RENT_INCREMENT       = num('rentIncrement') / 100;
    const RENT_DEPOSIT         = num('rentDeposit');
    const DEPOSIT_REFUND_DELAY = num('depositRefundDelay');
    const WITHHOLDING_RAW      = num('withholding') / 100;
    const REFUND_DELAY         = num('refundDelay');
    const LOAN_TENURE          = num('loanTenure');
    const LEASE_TENURE         = num('leaseTenure');
    const INFLATION_ANNUAL     = num('inflationRate');
    const LIQUIDITY_ANNUAL     = num('liquidityPremium');
    const VOLATILITY           = num('returnVol') / 100;

    const chartColor = getChartColor(INFLATION_ANNUAL, LIQUIDITY_ANNUAL);

    if (LEASE_AMOUNT <= 0 || LEASE_TENURE <= 0 || MARKET_RENT <= 0) return;

    const OWN_FUNDS           = Math.max(0, LEASE_AMOUNT - LOAN_AMOUNT);
    const effectiveLoanMonths = LOAN_TENURE > 0 ? Math.min(LOAN_TENURE, LEASE_TENURE) : 0;
    const WITHHOLDING         = Math.min(1, Math.max(0, WITHHOLDING_RAW));

    const LOAN_RATE_MONTHLY  = (LOAN_RATE_ANNUAL / 100) / 12;
    const OPP_RATE_NOMINAL   = (OPP_RATE_ANNUAL / 100) / 12;
    const INFLATION_MONTHLY  = (INFLATION_ANNUAL / 100) / 12;
    const LIQUIDITY_MONTHLY  = (LIQUIDITY_ANNUAL / 100) / 12;

    const REAL_OPP_RATE   = (1 + OPP_RATE_NOMINAL) / (1 + INFLATION_MONTHLY) - 1;
    const LOCKED_FUNDS_RATE = REAL_OPP_RATE + LIQUIDITY_MONTHLY;

    const growthToEnd = new Array(LEASE_TENURE + 1);
    for (let m = 1; m <= LEASE_TENURE; m++) {
      growthToEnd[m] = Math.pow(1 + REAL_OPP_RATE, LEASE_TENURE - m + 1) - 1;
    }
    const maxYear = Math.floor((LEASE_TENURE - 1) / 12) + 1;
    const rentGrowth = new Array(maxYear + 1);
    for (let y = 0; y <= maxYear; y++) {
      rentGrowth[y] = Math.pow(1 + RENT_INCREMENT, y);
    }

    const EMI = effectiveLoanMonths <= 0 ? 0
              : calcEMI(LOAN_AMOUNT, LOAN_RATE_MONTHLY, effectiveLoanMonths);

    const totalInterestPaid    = effectiveLoanMonths > 0 ? (EMI * effectiveLoanMonths) - LOAN_AMOUNT : 0;
    const ExpectedDamageFactor = 0.5;
    const withholdingLoss      = LEASE_AMOUNT * WITHHOLDING * ExpectedDamageFactor;
    const depositRefundable    = LEASE_AMOUNT * (1 - WITHHOLDING);
    const ownFundsOppCost      = OWN_FUNDS * (Math.pow(1 + LOCKED_FUNDS_RATE, LEASE_TENURE) - 1);
    const delayCost            = REFUND_DELAY > 0
                                 ? depositRefundable * (Math.pow(1 + LOCKED_FUNDS_RATE, REFUND_DELAY) - 1)
                                 : 0;
    const totalMaintenanceCost = MAINTENANCE * LEASE_TENURE;

    let emiOppLoss  = 0;
    let emiOppGain  = 0;
    let totalRentPaid = 0;

    for (let m = 1; m <= LEASE_TENURE; m++) {
      const yearIndex        = Math.floor((m - 1) / 12);
      const monthlyRent      = MARKET_RENT * rentGrowth[yearIndex];
      const monthlyOutflow   = m <= effectiveLoanMonths ? (EMI + MAINTENANCE) : MAINTENANCE;
      const g                = growthToEnd[m];

      totalRentPaid += monthlyRent;

      const difference = monthlyOutflow - monthlyRent;
      if (difference > 0) {
        emiOppLoss += difference * g;
      } else {
        emiOppGain += Math.abs(difference) * g;
      }
    }
    const netEmiOpp = emiOppLoss - emiOppGain;

    const effectiveRiskPremium = RISK_PREMIUM * (1 + VOLATILITY);
    const riskCost             = LEASE_AMOUNT * effectiveRiskPremium * (LEASE_TENURE / 12);

    const totalLeaseCostWithoutRisk =
        totalInterestPaid
      + withholdingLoss
      + ownFundsOppCost
      + delayCost
      + totalMaintenanceCost
      + netEmiOpp;

    const riskAdjustedLeaseCost = totalLeaseCostWithoutRisk + riskCost;
    const monthlyLeaseCost      = riskAdjustedLeaseCost / LEASE_TENURE;

    const rentDepositOppCost      = RENT_DEPOSIT * (Math.pow(1 + REAL_OPP_RATE, LEASE_TENURE) - 1);
    const rentDepositDelayOppCost = DEPOSIT_REFUND_DELAY > 0
                                    ? RENT_DEPOSIT * (Math.pow(1 + REAL_OPP_RATE, DEPOSIT_REFUND_DELAY) - 1)
                                    : 0;
    const totalRentCost  = totalRentPaid + rentDepositOppCost + rentDepositDelayOppCost;
    const monthlyRentCost = totalRentCost / LEASE_TENURE;

    const costRatio = totalRentCost === 0 ? 0 : riskAdjustedLeaseCost / totalRentCost;

    const stabilizedRatio = Math.log(1 + costRatio) / Math.log(2);
    const NEUTRAL_BAND    = 0.05;
    const finalRatio      = Math.abs(costRatio - 1) < NEUTRAL_BAND ? 1 : stabilizedRatio;
    const score           = Math.max(0, Math.min(100, 50 + 50 * (1 - finalRatio)));
    const decisionStrength = Math.max(0, Math.min(100, Math.abs(finalRatio - 1) * 120));

    const monthlySavings = monthlyRentCost - monthlyLeaseCost;
    const yearlySavings  = monthlySavings * 12;
    const termSavings    = monthlySavings * LEASE_TENURE;

    // ====== UPDATE UI ======

    $('emiLabel').innerText  = 'EMI: ' + formatCurrency(EMI);
    $('oppLabel').innerText  = 'Own Funds Opp Cost: ' + formatCurrency(ownFundsOppCost);
    $('riskLabel').innerText = 'Risk Buffer: ' + formatCurrency(LEASE_AMOUNT * RISK_PREMIUM);

    $('mEMI').innerText       = formatCurrency(EMI);
    $('mRiskRent').innerText  = formatCurrency(monthlyLeaseCost);
    $('mSave').innerText      = formatCurrency(monthlySavings);
    $('mSaveSub').innerText   = monthlySavings >= 0 ? '‚úÖ Lease is cheaper' : '‚ùå Rent is cheaper';
    
    // Update metric card styling
    const savingsCard = $('savingsCard');
    const annualCard = $('annualCard');
    const termCard = $('termCard');
    const scoreCard = $('scoreCard');
    
    savingsCard.classList.remove('positive', 'negative', 'neutral');
    annualCard.classList.remove('positive', 'negative', 'neutral');
    termCard.classList.remove('positive', 'negative', 'neutral');
    scoreCard.classList.remove('positive', 'negative', 'neutral');
    
    if (monthlySavings > 50) {
      savingsCard.classList.add('positive');
      annualCard.classList.add('positive');
      termCard.classList.add('positive');
      scoreCard.classList.add('positive');
    } else if (monthlySavings < -50) {
      savingsCard.classList.add('negative');
      annualCard.classList.add('negative');
      termCard.classList.add('negative');
      scoreCard.classList.add('negative');
    } else {
      savingsCard.classList.add('neutral');
      annualCard.classList.add('neutral');
      termCard.classList.add('neutral');
      scoreCard.classList.add('neutral');
    }
    
    $('ySave').innerText      = formatCurrency(yearlySavings);
    $('tSave').innerText      = formatCurrency(termSavings);
    $('mConfidence').innerText= Math.round(decisionStrength) + '%';
    $('scoreValue').innerText = Math.round(score) + '%';
    $('scoreChange').innerText = score >= 50 ? '‚úÖ Lease Favored' : '‚ùå Rent Favored';
    $('scoreChange').style.color = score >= 50 ? 'var(--success)' : 'var(--danger)';

    let gaugeColor = '#f59e0b';
    let interpretation = 'üìä Balanced decision ‚Äî consider other factors';
    if (score >= 85) {
      gaugeColor = '#10b981';
      interpretation = 'üéØ Excellent Leasing Advantage ‚Äî highly favorable to lease';
    } else if (score >= 65) {
      gaugeColor = '#00d9ff';
      interpretation = '‚úÖ Strong Leasing Advantage ‚Äî leasing is recommended';
    } else if (score >= 50) {
      gaugeColor = '#f59e0b';
      interpretation = 'üìä Marginal Leasing Advantage ‚Äî consider flexibility & other factors';
    } else if (score >= 35) {
      gaugeColor = '#f97316';
      interpretation = '‚ö†Ô∏è Slight Renting Advantage ‚Äî renting is marginally better';
    } else {
      gaugeColor = '#ef4444';
      interpretation = '‚ùå Strong Renting Advantage ‚Äî renting is significantly more economical';
    }

    const deg = score * 3.6;
    $('gauge').style.background = `conic-gradient(from 0deg, ${gaugeColor} 0deg, ${gaugeColor} ${deg}deg, rgba(36,53,72,0.3) ${deg}deg, rgba(36,53,72,0.3) 360deg)`;
    $('gauge').style.boxShadow  = `0 0 40px ${gaugeColor}40, inset 0 0 40px ${gaugeColor}10`;
    $('dial').innerText  = Math.round(score);
    $('dial').style.color = gaugeColor;
    $('scoreInterpretation').innerText = interpretation;

    // ====== CHART DATA PREP ======

    const tcoLabels = ['Interest Paid','Own Funds Opp Cost','Net EMI Opp Cost','Total Maintenance','Withholding Loss','Refund Delay Cost'];
    const tcoValues = [
      Math.max(0, totalInterestPaid),
      Math.max(0, ownFundsOppCost),
      Math.max(0, netEmiOpp),
      Math.max(0, totalMaintenanceCost),
      Math.max(0, withholdingLoss),
      Math.max(0, delayCost)
    ];

    const displayMonths = Math.min(LEASE_TENURE, 60);
    const monthLabels = [], monthlyEMICosts = [], monthlyRentSeries = [];
    for (let m = 1; m <= displayMonths; m++) {
      monthLabels.push('M' + m);
      monthlyEMICosts.push(m <= effectiveLoanMonths ? (EMI + MAINTENANCE) : MAINTENANCE);
      const Y = Math.floor((m - 1) / 12);
      monthlyRentSeries.push(MARKET_RENT * Math.pow(1 + RENT_INCREMENT, Y));
    }

    const cumMonths = Math.min(LEASE_TENURE, 120);
    const cumLabels = [], cumLease = [], cumRent = [];
    let runLease = 0, runRent = 0;
    for (let m = 1; m <= cumMonths; m++) {
      runLease += monthlyLeaseCost;
      const Y = Math.floor((m - 1) / 12);
      runRent += MARKET_RENT * Math.pow(1 + RENT_INCREMENT, Y);
      cumLease.push(runLease);
      cumRent.push(runRent);
      cumLabels.push(m % 12 === 1 ? 'Y' + (Math.floor((m-1)/12)+1) : '');
    }

    const fwdLabels = [], fwdRentMonthly = [], fwdLeaseFlat = [], fwdCumRent = [];
    let fwdTotal = 0;
    for (let m = 1; m <= Math.min(LEASE_TENURE, 120); m++) {
      const Y = Math.floor((m - 1) / 12);
      const r = MARKET_RENT * Math.pow(1 + RENT_INCREMENT, Y);
      fwdTotal += r;
      fwdRentMonthly.push(r);
      fwdLeaseFlat.push(monthlyLeaseCost);
      fwdCumRent.push(fwdTotal);
      fwdLabels.push(m % 12 === 1 ? 'Y' + (Math.floor((m-1)/12)+1) : '');
    }

    const compLabels = ['Interest','Own Funds Opp','Net EMI Opp','Maintenance','Withholding','Refund Delay'];
    const compValues = [
      Math.max(1, totalInterestPaid),
      Math.max(1, ownFundsOppCost),
      Math.max(1, netEmiOpp),
      Math.max(1, totalMaintenanceCost),
      Math.max(1, withholdingLoss),
      Math.max(1, delayCost)
    ];

    const sensLabels = [], sensValues = [];
    for (let r = -20; r <= 20; r += 2) {
      const adjRiskRent = monthlyLeaseCost * (1 + r / 100);
      sensLabels.push(r + '%');
      sensValues.push(monthlyRentCost - adjRiskRent);
    }

    const amorMonths = Math.min(effectiveLoanMonths, 60);
    const amorLabels = [], principalData = [], interestData = [];
    let bal = LOAN_AMOUNT;
    for (let m = 1; m <= amorMonths; m++) {
      const intPmt = bal * LOAN_RATE_MONTHLY;
      const prinPmt = EMI - intPmt;
      bal -= prinPmt;
      amorLabels.push('M' + m);
      principalData.push(Math.max(0, prinPmt));
      interestData.push(Math.max(0, intPmt));
    }

    renderTCO(tcoLabels, tcoValues);
    renderMonthlyCost(monthLabels, monthlyEMICosts, monthlyRentSeries);
    renderCumulative(cumLabels, cumLease, cumRent);
    renderForwardRent(fwdLabels, fwdRentMonthly, fwdLeaseFlat, fwdCumRent, chartColor);
    renderComposition(compLabels, compValues);
    renderSensitivity(sensLabels, sensValues, chartColor);
    renderAmortization(amorLabels, principalData, interestData);

  } catch (err) {
    console.error('Calculation error:', err);
  }
}

// ====== CHART RENDERERS ======

function renderTCO(labels, values) {
  if (!tcoChart) {
    tcoChart = new Chart($('tcoChart'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Economic Cost',
          data: values,
          backgroundColor: ['#ef4444','#6366f1','#8b5cf6','#f59e0b','#ec4899','#00d9ff'],
          borderWidth: 0
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end', align: 'right',
            color: '#f0f4f8',
            font: { weight: 'bold', size: 11 },
            formatter: v => formatCurrency(v),
            padding: 4
          }
        },
        scales: {
          x: { ticks: { callback: v => formatCurrency(v), color: '#94a3b8', font: { size: 11 } }, grid: { color: 'rgba(0,217,255,0.05)' } },
          y: { ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { display: false } }
        }
      },
      plugins: [ChartDataLabels]
    });
  } else {
    tcoChart.data.labels = labels;
    tcoChart.data.datasets[0].data = values;
    tcoChart.update();
  }
}

function renderMonthlyCost(labels, leaseCosts, rentSeries) {
  if (!monthlyCostChart) {
    monthlyCostChart = new Chart($('monthlyCostChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Market Rent (Escalating)',
            data: rentSeries,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,0.1)',
            borderWidth: 3, fill: true, tension: 0.4,
            pointRadius: 0, pointHoverRadius: 6
          },
          {
            label: 'EMI + Maintenance Outflow',
            data: leaseCosts,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.1)',
            borderWidth: 3, fill: true, tension: 0.4,
            pointRadius: 0, pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'bottom', labels: { padding: 20, font: { size: 12, weight: '600' } } },
          datalabels: { display: false }
        },
        scales: {
          y: { ticks: { callback: v => formatCurrency(v), color: '#94a3b8', font: { size: 11 } }, grid: { color: 'rgba(0,217,255,0.05)' } },
          x: { ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { display: false } }
        }
      }
    });
  } else {
    monthlyCostChart.data.labels = labels;
    monthlyCostChart.data.datasets[0].data = rentSeries;
    monthlyCostChart.data.datasets[1].data = leaseCosts;
    monthlyCostChart.update();
  }
}

function renderCumulative(labels, leaseCosts, rentCosts) {
  if (!cumulativeCostChart) {
    cumulativeCostChart = new Chart($('cumulativeCostChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Cumulative Lease Cost (Economic)',
            data: leaseCosts,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.1)',
            borderWidth: 3, fill: true, tension: 0.4,
            pointRadius: 0, pointHoverRadius: 6
          },
          {
            label: 'Cumulative Market Rent',
            data: rentCosts,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,0.1)',
            borderWidth: 3, fill: true, tension: 0.4,
            pointRadius: 0, pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'bottom', labels: { padding: 20, font: { size: 12, weight: '600' } } },
          datalabels: { display: false }
        },
        scales: {
          y: { ticks: { callback: v => formatCurrency(v), color: '#94a3b8', font: { size: 11 } }, grid: { color: 'rgba(0,217,255,0.05)' } },
          x: { ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { display: false } }
        }
      }
    });
  } else {
    cumulativeCostChart.data.labels = labels;
    cumulativeCostChart.data.datasets[0].data = leaseCosts;
    cumulativeCostChart.data.datasets[1].data = rentCosts;
    cumulativeCostChart.update();
  }
}

function renderForwardRent(labels, monthly, flat, cumulative, chartColor = '#10b981') {
  if (!forwardRentChart) {
    forwardRentChart = new Chart($('forwardRentChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Market Rent (Escalating)',
            data: monthly,
            borderColor: chartColor,
            backgroundColor: chartColor + '20',
            borderWidth: 2, fill: false, tension: 0.4, pointRadius: 0
          },
          {
            label: 'Lease Economic Cost (Fixed)',
            data: flat,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.1)',
            borderWidth: 2, fill: false, tension: 0, pointRadius: 0,
            borderDash: [6, 4]
          },
          {
            label: 'Cumulative Rent Burden',
            data: cumulative,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245,158,11,0.1)',
            borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'bottom', labels: { padding: 20, font: { size: 12, weight: '600' } } },
          datalabels: { display: false }
        },
        scales: {
          y: {
            title: { display: true, text: 'Monthly Cost', color: '#94a3b8', font: { size: 11 } },
            ticks: { callback: v => formatCurrency(v), color: '#94a3b8', font: { size: 11 } },
            grid: { color: 'rgba(0,217,255,0.05)' }
          },
          y1: {
            position: 'right',
            title: { display: true, text: 'Cumulative', color: '#94a3b8', font: { size: 11 } },
            ticks: { callback: v => formatCurrency(v), color: '#94a3b8', font: { size: 11 } },
            grid: { drawOnChartArea: false }
          },
          x: { ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { display: false } }
        }
      }
    });
  } else {
    forwardRentChart.data.labels = labels;
    forwardRentChart.data.datasets[0].data = monthly;
    forwardRentChart.data.datasets[0].borderColor = chartColor;
    forwardRentChart.data.datasets[0].backgroundColor = chartColor + '20';
    forwardRentChart.data.datasets[1].data = flat;
    forwardRentChart.data.datasets[2].data = cumulative;
    forwardRentChart.update();
  }
}

function renderComposition(labels, values) {
  if (!compositionChart) {
    compositionChart = new Chart($('compositionChart'), {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: ['#ef4444','#6366f1','#8b5cf6','#f59e0b','#ec4899','#00d9ff'],
          borderWidth: 3
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'bottom', labels: { padding: 16, font: { size: 12, weight: '600' } } },
          datalabels: {
            color: '#f0f4f8',
            font: { weight: 'bold', size: 11 },
            formatter: (v, ctx) => {
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              return ((v / total) * 100).toFixed(1) + '%';
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  } else {
    compositionChart.data.labels = labels;
    compositionChart.data.datasets[0].data = values;
    compositionChart.update();
  }
}

function renderSensitivity(labels, values, chartColor = '#00d9ff') {
  if (!sensitivityChart) {
    sensitivityChart = new Chart($('sensitivityChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Monthly Savings',
          data: values,
          borderColor: chartColor,
          backgroundColor: chartColor + '20',
          borderWidth: 3, fill: true, tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: chartColor,
          pointBorderColor: '#0f1e2e',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'bottom', labels: { padding: 20, font: { size: 12, weight: '600' } } },
          datalabels: { display: false }
        },
        scales: {
          y: { ticks: { callback: v => formatCurrency(v), color: '#94a3b8', font: { size: 11 } }, grid: { color: 'rgba(0,217,255,0.05)' } },
          x: { ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { display: false } }
        }
      }
    });
  } else {
    sensitivityChart.data.labels = labels;
    sensitivityChart.data.datasets[0].data = values;
    sensitivityChart.data.datasets[0].borderColor = chartColor;
    sensitivityChart.data.datasets[0].backgroundColor = chartColor + '20';
    sensitivityChart.data.datasets[0].pointBackgroundColor = chartColor;
    sensitivityChart.update();
  }
}

function renderAmortization(labels, principal, interest) {
  if (!amortizationChart) {
    amortizationChart = new Chart($('amortizationChart'), {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Principal', data: principal, backgroundColor: '#10b981', borderRadius: 4, borderWidth: 0 },
          { label: 'Interest',  data: interest,  backgroundColor: '#ef4444', borderRadius: 4, borderWidth: 0 }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'bottom', labels: { padding: 20, font: { size: 12, weight: '600' } } },
          datalabels: { display: false }
        },
        scales: {
          x: { stacked: true, ticks: { color: '#94a3b8', font: { size: 11 } }, grid: { display: false } },
          y: { stacked: true, ticks: { callback: v => formatCurrency(v), color: '#94a3b8', font: { size: 11 } }, grid: { color: 'rgba(0,217,255,0.05)' } }
        }
      }
    });
  } else {
    amortizationChart.data.labels = labels;
    amortizationChart.data.datasets[0].data = principal;
    amortizationChart.data.datasets[1].data = interest;
    amortizationChart.update();
  }
}

// Initial run
calculate();
</script>

</body>
</html>
